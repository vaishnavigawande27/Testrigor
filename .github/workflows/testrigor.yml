name: Run TestRigor

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  testrigor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run TestRigor API script
        id: testrun
        env:
          APP_ID: XaF3XkqTdMiNwApoN
          AUTH_TOKEN: YUQjfG0W0ywpfEmeXTPyVEU0vLJoEMRa81JejA0YBlClvUKArO9m
        run: |
          BASE_URL="https://api.testrigor.com/api/v1/apps/$APP_ID"

          echo "Starting TestRigor test..."

          start_code=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST \
            -H "Content-type: application/json" \
            -H "auth-token: $AUTH_TOKEN" \
            --data '{"forceCancelPreviousTesting":true}' \
            "$BASE_URL/retest")

          if [ "$start_code" != "200" ]; then
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "Failed to start test. HTTP $start_code"
            exit 1
          fi

          echo "Test started successfully"
          sleep 15

          while true; do
            response=$(curl -s -w "\n%{http_code}" \
              -H "auth-token: $AUTH_TOKEN" \
              -H "Accept: application/json" \
              "$BASE_URL/status")

            body=$(echo "$response" | sed '$d')
            code=$(echo "$response" | tail -n1)

            echo "HTTP Status: $code"
            echo "Response: $body"

            case "$code" in
              200)
                echo "status=success" >> $GITHUB_OUTPUT
                exit 0
                ;;
              227|228)
                echo "Test still running..."
                ;;
              229|230)
                echo "status=failed" >> $GITHUB_OUTPUT
                exit 1
                ;;
              4*|5*)
                echo "status=failed" >> $GITHUB_OUTPUT
                exit 1
                ;;
              *)
                echo "status=failed" >> $GITHUB_OUTPUT
                exit 1
                ;;
            esac

            sleep 15
          done

      - name: Notify Slack - Success
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{
            "text": "✅ TestRigor test PASSED for repository ${{ github.repository }} on branch ${{ github.ref_name }}."
          }' \
          ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack - Failure
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{
            "text": "❌ TestRigor test FAILED for repository ${{ github.repository }} on branch ${{ github.ref_name }}.\nCheck run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }' \
          ${{ secrets.SLACK_WEBHOOK_URL }}
