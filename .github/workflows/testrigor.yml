name: CI - testRigor

on:
  push:
    branches: [ main ]

jobs:
  run-testrigor:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repo
      - name: Checkout
        uses: actions/checkout@v3

      # Step 2: Trigger and wait for testRigor suite
      - name: Run testRigor login test
        run: |
          #!/bin/bash
          set -e

          # Use your testRigor API token here
          TOKEN="YUQjfG0W0ywpfEmeXTPyVEU0vLJoEMRa81JejA0YBlClvUKArO9m"
          SUITE_ID="XaF3XkqTdMiNwApoN"

          echo "üöÄ Triggering testRigor suite..."
          TRIGGER=$(curl -s -X POST \
            -H "Content-type: application/json" \
            -H "auth-token: $TOKEN" \
            --data '{"forceCancelPreviousTesting":true}' \
            https://api.testrigor.com/api/v1/apps/$SUITE_ID/retest)

          echo "Trigger response: $TRIGGER"

          if echo "$TRIGGER" | grep -q "Unauthorized"; then
            echo "‚ùå Unauthorized ‚Äî check API token"
            exit 1
          fi
          if echo "$TRIGGER" | grep -q "NOT_FOUND"; then
            echo "‚ùå Suite not found ‚Äî check SUITE_ID"
            exit 1
          fi

          echo "‚è≥ Waiting for test result..."
          MAX_WAIT=120   # Max 2 minutes for single login test
          SLEEP=5        # Poll every 5 seconds
          ELAPSED=0

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            STATUS=$(curl -s -X GET \
              -H "auth-token: $TOKEN" \
              https://api.testrigor.com/api/v1/apps/$SUITE_ID/status)

            # Print for debugging
            echo "Status response: $STATUS"

            # Check for pass/fail
            if echo "$STATUS" | grep -q '"result":"pass"'; then
              echo "‚úÖ Test PASSED"
              exit 0
            fi
            if echo "$STATUS" | grep -q '"result":"fail"'; then
              echo "‚ùå Test FAILED"
              exit 1
            fi

            sleep $SLEEP
            ELAPSED=$((ELAPSED + SLEEP))
          done

          echo "‚ö†Ô∏è Test did not finish within $MAX_WAIT seconds"
          exit 1

      # Step 3: Slack notification on success
      - name: Slack on success
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{"text":"‚úÖ testRigor login test PASSED"}' \
          ${{ secrets.SLACK_WEBHOOK_URL }}

      # Step 4: Slack notification on failure
      - name: Slack on failure
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{"text":"‚ùå testRigor login test FAILED"}' \
          ${{ secrets.SLACK_WEBHOOK_URL }}
