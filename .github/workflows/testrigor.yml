name: CI - testrigor

on:
  push:
    branches: [ main ]

jobs:
  run-testrigor:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout code
      - name: Checkout
        uses: actions/checkout@v3

      # Step 2: Trigger cloud suite
      - name: Trigger testrigor suite
        id: run_suite
        run: |
          echo "Triggering testrigor suite..."
          RESPONSE=$(curl -s -X POST "https://api.testrigor.com/api/run" \
            -H "Authorization: Bearer ${{ secrets.TESTRIGOR_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"testSuiteId\":\"XaF3XkqTdMiNwApoN\"}")

          echo "response=$RESPONSE" >> $GITHUB_OUTPUT

      # Step 3: Check suite result
      - name: Check result
        run: |
          RAW="${{ steps.run_suite.outputs.response }}"
          STATUS=$(echo "$RAW" | grep -o '"status":"[A-Z]*"' | sed 's/"status":"//;s/"//')

          echo "Suite Status: $STATUS"

          if [ "$STATUS" = "FAILED" ]; then
            echo "Tests failed!"
            exit 1
          fi

      # Step 4: Notify Slack on failure
      - name: Slack on failure
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{"text":"❌ testrigor Tests FAILED"}' ${{ secrets.SLACK_WEBHOOK_URL }}

      # Step 5: Notify Slack on success
      - name: Slack on success
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{"text":"✅ testrigor Tests PASSED"}' ${{ secrets.SLACK_WEBHOOK_URL }}
