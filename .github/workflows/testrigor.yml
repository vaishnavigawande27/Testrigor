name: Webmail Login Test CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # Checkout the code from the repository
      - name: Checkout Code
        uses: actions/checkout@v4

      # Set environment variables for email and password
      - name: Set up environment variables
        run: |
          echo "EMAIL_USERNAME=${{ secrets.EMAIL_USERNAME }}" >> $GITHUB_ENV
          echo "EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }}" >> $GITHUB_ENV
          echo "EMAIL_USERNAME: $EMAIL_USERNAME"  # Debugging the environment variable

      # Install necessary dependencies (e.g., curl)
      - name: Install Dependencies (curl)
        run: |
          sudo apt-get update
          sudo apt-get install -y curl

      # Run the webmail login test script
      - name: Run Webmail Login Tests
        run: ./run_testrigor_tests.sh

      # Upload the test report (this will be generated dynamically)
      - name: Upload Test Report
        if: success()  # Only upload if the test was successful
        uses: actions/upload-artifact@v4
        with:
          name: webmail-login-report
          path: ./report.html  # This path corresponds to the dynamically generated report

      # Send email notification if the test passes
      - name: Send Notification Email (Success)
        if: success()
        uses: dawidd6/action-send-mail@v4
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "Webmail Login Test Passed"
          to: vgawande@microproindia.com
          from: vgawande@microproindia.com
          body: "The webmail login test ran successfully. View the test report in the artifact."


      # Optionally, send failure notification if the test fails
      - name: Send Failure Notification Email
        if: failure()  # Only send if the test fails
        uses: dawidd6/action-send-mail@v4
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "Webmail Login Test Failed"
          to: vgawande@microproindia.com
          from: vgawande@microproindia.com
          body: "The webmail login test failed. Please check the test report for details."
