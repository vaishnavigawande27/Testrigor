name: CI - testrigor

on:
  push:
    branches: [ main ]

jobs:
  run-testrigor-suite:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Trigger and wait for testrigor suite result
        run: |
          #!/bin/bash
          set -e

          TOKEN="YUQjfG0W0ywpfEmeXTPyVEU0vLJoEMRa81JejA0YBlClvUKArO9m"
          SUITE_ID="XaF3XkqTdMiNwApoN"

          echo "üöÄ Triggering testRigor suite..."

          RESPONSE=$(curl -s -X POST \
            -H "Content-type: application/json" \
            -H "auth-token: $TOKEN" \
            --data '{"forceCancelPreviousTesting":true}' \
            https://api.testrigor.com/api/v1/apps/$SUITE_ID/retest)

          echo "Trigger response: $RESPONSE"

          if echo "$RESPONSE" | grep -q "Unauthorized"; then
            echo "‚ùå Unauthorized access"
            exit 1
          fi

          echo "‚è≥ Waiting for test result..."

          MAX_WAIT=900        # wait max 15 minutes
          SLEEP_INTERVAL=10
          ELAPSED=0

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            STATUS_RESPONSE=$(curl -s -X GET \
              -H "auth-token: $TOKEN" \
              -H "Accept: application/json" \
              https://api.testrigor.com/api/v1/apps/$SUITE_ID/status)

            STATUS=$(echo "$STATUS_RESPONSE" | grep -o '"result":"[a-z]*"' | sed 's/"result":"//;s/"//')

            if [[ "$STATUS" == "pass" ]]; then
              echo "‚úÖ Test suite PASSED"
              exit 0
            elif [[ "$STATUS" == "fail" ]]; then
              echo "‚ùå Test suite FAILED"
              exit 1
            fi

            sleep $SLEEP_INTERVAL
            ELAPSED=$((ELAPSED + SLEEP_INTERVAL))
          done

          echo "‚ö†Ô∏è Test suite timed out"
          exit 1

      - name: Notify Slack on failure
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{"text":"‚ùå testrigor Suite FAILED\nRepo: '${{ github.repository }}'\nBranch: '${{ github.ref_name }}'"}' \
          ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack on success
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{"text":"‚úÖ testrigor Suite PASSED\nRepo: '${{ github.repository }}'\nBranch: '${{ github.ref_name }}'"}' \
          ${{ secrets.SLACK_WEBHOOK_URL }}
