#!/usr/bin/env bash

APP_ID="XaF3XkqTdMiNwApoN"
AUTH_TOKEN="YUQjfG0W0ywpfEmeXTPyVEU0vLJoEMRa81JejA0YBlClvUKArO9m"
BASE_URL="https://api.testrigor.com/api/v1/apps/$APP_ID"

# Start retest
curl -s -X POST \
  -H "Content-type: application/json" \
  -H "auth-token: $AUTH_TOKEN" \
  --data '{"forceCancelPreviousTesting":true,"storedValues":{"storedValueName1":"Value"}}' \
  "$BASE_URL/retest"

sleep 10

while true; do
  echo
  echo "==================================="
  echo " Checking run status"
  echo "==================================="

  # Capture response body and status code separately
  response=$(curl -s -w "\n%{http_code}" \
    -H "auth-token: $AUTH_TOKEN" \
    -H "Accept: application/json" \
    "$BASE_URL/status")

  body=$(echo "$response" | sed '$d')
  code=$(echo "$response" | tail -n1)

  echo "Status code: $code"
  echo "Response: $body"

  case "$code" in
    4*|5*)
      echo "Error calling API"
      exit 1
      ;;
    200)
      echo "Test finished successfully"
      exit 0
      ;;
    227|228)
      echo "Test is not finished yet"
      ;;
    229)
      echo "Test canceled"
      exit 1
      ;;
    230)
      echo "Test finished but failed"
      exit 1
      ;;
    *)
      echo "Unknown status"
      exit 1
      ;;
  esac

  sleep 10
done
