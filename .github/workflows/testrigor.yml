name: CI - testRigor

on:
  push:
    branches: [ main ]

jobs:
  run-testrigor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Trigger testRigor suite and short poll
        run: |
          #!/bin/bash
          set -e

          TOKEN="YUQjfG0W0ywpfEmeXTPyVEU0vLJoEMRa81JejA0YBlClvUKArO9m"
          SUITE_ID="XaF3XkqTdMiNwApoN"

          echo "ðŸš€ Triggering testRigor suite..."
          TRIGGER_RESPONSE=$(curl -s -X POST \
            -H "Content-type: application/json" \
            -H "auth-token: $TOKEN" \
            --data '{"forceCancelPreviousTesting":true}' \
            https://api.testrigor.com/api/v1/apps/$SUITE_ID/retest)
          echo "Trigger response: $TRIGGER_RESPONSE"

          # Short polling
          MAX_POLLS=4
          SLEEP=10
          for ((i=1;i<=MAX_POLLS;i++)); do
            STATUS_RESPONSE=$(curl -s -X GET \
              -H "auth-token: $TOKEN" \
              https://api.testrigor.com/api/v1/apps/$SUITE_ID/status)
            echo "Poll $i: $STATUS_RESPONSE"

            if echo "$STATUS_RESPONSE" | grep -q '"result": "pass"'; then
              echo "âœ… Test PASSED"
              exit 0
            fi
            if echo "$STATUS_RESPONSE" | grep -q '"result": "fail"'; then
              echo "âŒ Test FAILED"
              exit 1
            fi

            echo "Test still running..."
            sleep $SLEEP
          done

          echo "âš ï¸ Test did not finish within polling time"
          exit 1

      - name: Slack on success
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{"text":"âœ… testRigor Suite PASSED"}' \
          ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Slack on failure
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{"text":"âŒ testRigor Suite FAILED"}' \
          ${{ secrets.SLACK_WEBHOOK_URL }}
