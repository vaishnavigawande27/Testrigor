name: CI - testrigor

on:
  push:
    branches: [ main ]

jobs:
  run-testrigor-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install jq
        run: sudo apt-get install jq

      - name: Run testrigor suite and wait for result
        run: |
          echo "Triggering suite..."

          RESPONSE=$(curl -s -X POST "https://api.testrigor.com/api/run" \
            -H "Authorization: Bearer ${{ secrets.TESTRIGOR_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"testSuiteId":"XaF3XkqTdMiNwApoN"}')

          RUN_ID=$(echo $RESPONSE | jq -r '.id')

          echo "Run ID: $RUN_ID"
          echo "Waiting for completion..."

          while true; do
            STATUS_RESPONSE=$(curl -s -X GET "https://api.testrigor.com/api/runs/$RUN_ID" \
              -H "Authorization: Bearer ${{ secrets.TESTRIGOR_API_KEY }}")

            STATUS=$(echo $STATUS_RESPONSE | jq -r '.status')

            echo "Current Status: $STATUS"

            if [ "$STATUS" == "PASSED" ]; then
              echo "Tests passed!"
              exit 0
            elif [ "$STATUS" == "FAILED" ]; then
              echo "Tests failed!"
              exit 1
            fi

            sleep 20
          done

      - name: Notify Slack on failure
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{"text":"❌ testrigor Tests FAILED!"}' \
          ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack on success
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{"text":"✅ testrigor Tests PASSED!"}' \
          ${{ secrets.SLACK_WEBHOOK_URL }}
